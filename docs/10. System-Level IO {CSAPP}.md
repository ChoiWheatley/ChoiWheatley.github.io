---
aliases: []
tags: []
description: 11ì¥ì´ ì˜ì¡´í•˜ëŠ” í•„ìˆ˜ê°œë…ë“¤ ì§šê³  ë„˜ì–´ê°€ì
title: 10. System-Level IO {CSAPP}
created: 2023-09-14T14:07:44
updated: 2023-09-16T22:59:27
---
- [[0121 CSAPP Third Edition Bryant, Randal E. O'Hallaron, David.]]
- [[07. Input Output {SP}]] | file descriptor, standard io, `read`, `write`, `open`, `close` ë“±ì— ëŒ€í•œ ë‚´ìš©.
- [[11. memory mapping and Copy-on-write (COW) {SP}]] | `fork`ì™€ `execve`, shared libraryë¥¼ ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ê°€ ê³µìœ í•˜ëŠ” ê¸°ë²•ì¸ Copy on Write ê¸°ë²•, ëŒ€ë§ì˜ `mmap`
- [[11. Network Programming {CSAPP}]] ì±•í„°ì—ì„œ `Tiny` ì›¹ ì„œë²„ë¥¼ ë§Œë“¤ ë•Œ í•„ìš”í•œ `RIO` íŒ¨í‚¤ì§€ê°€ ì´ ì±•í„°ì— ë“¤ì–´ìˆìŒ.

## README

ì´ íŒŒì¼ì€ ì‚¬ì‹¤ [[11. Network Programming {CSAPP}]], ì›¹ ì„œë²„ ë§Œë“œëŠ” ë° í•„ìš”í•œ `RIO` íŒ¨í‚¤ì§€ ë•Œë¬¸ì— ë„˜ì–´ì™”ë‹¤. íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ì™€ ì…ë ¥ì¶œë ¥ì— ëŒ€í•œ ë‚´ìš©ì„ ë¹ ë¥´ê²Œ ì§šê³  ë°”ë¡œ `RIO` íŒ¨í‚¤ì§€ êµ¬í˜„ì²´ë¡œ ë„˜ì–´ê°ˆ ê²ƒ. ëŒ€ì¶© ë´¤ëŠ”ë° ë²„í¼ê°€ ì—†ì–´ ë¹ ë¥´ë‹¤ê³ ?

> ìœ ë‹‰ìŠ¤ ì„¸ìƒì—ì„œ ëª¨ë“  ê²ƒì€ íŒŒì¼ì´ë‹¤.

ëŒ€í•™ì‹œì ˆ êµìˆ˜ë‹˜ì´ ê·€ì— ë”±ì§€ê°€ ì•‰ë„ë¡ ë§ì”€í•˜ì…¨ë‹¤. ê·¸ë˜ì„œ íŒŒì¼ì„ ì–´ë–»ê²Œ ë‹¤ë£¨ëŠ”ì§€, file descriptorê°€ ë¬´ì—‡ì¸ì§€, íŒŒì¼ ë©”íƒ€ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ì“°ëŠ”ì§€ ë“±ë“±ì— ëŒ€í•œ ë‚´ìš©ì„ [[0016 Systems Programming {ssu2021-1st} ğŸ¼]] ìˆ˜ì—…ì‹œê°„ì— ë“¤ì—ˆë‹¤.

> `mmap`ì€ ìœ ë‹‰ìŠ¤ ì„¸ìƒì—ì„œ ìŠ¤ìœ„ìŠ¤ ì•„ë¯¸ ë‚˜ì´í”„ì´ë‹¤.

ìì„¸í•œ ê±´ [[11. memory mapping and Copy-on-write (COW) {SP}]]ì—ì„œ í™•ì¸ë°”ëŒ.

![[ìŠ¤í¬ë¦°ìƒ· 2023-09-14 ì˜¤í›„ 9.19.57.png|800]]

## 10.5. Robust Reading and Writing with the `RIO` Package

ë‘ ê°€ì§€ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

1. Unbuffered Input & output: ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ì¤€ì˜ ë²„í¼ ì—†ì´ ê³§ì¥ fdë¥¼ ì‚¬ìš©í•´ íŒŒì¼ì„ ì½ê±°ë‚˜ ì“¸ ìˆ˜ ìˆë‹¤.
	1. `ssize_t rio_readn(int fd, void *usrbuf, size_t n);`
	2. `ssize_t rio_writen(int fd, void *usrbuf, size_t n);`
	3. Returns: number of bytes transferred if OK, 0 on EOF (rio_readn only), âˆ’1 on error
 
2. Buffered Input: thread safeí•œ ë²„í¼ê¸°ë°˜ ì…ë ¥ì„ í†µí•´ ì˜¤ë²„í—¤ë“œë¥¼ ì¤„ì¸ë‹¤.
	1. `ssize_t rio_readlineb(rio_t *rp, void *usrbuf, size_t maxlen);`
	2. `ssize_t rio_readnb(rio_t *rp, void *usrbuf, size_t n);`
	3. Returns: number of bytes read if OK, 0 on EOF, âˆ’1 on error

`void rio_readinitb(rio_t *rp, int fd);`: rio ê°ì²´ ì´ˆê¸°í™”, file descriptor í•„ìš”.

## 10.6. Readig File Metadata

```c
#include <unistd.h> 
#include <sys/stat.h> 
int stat(const char *filename, struct stat *buf); 
int fstat(int fd, struct stat *buf); 
// Returns: 0 if OK, âˆ’1 on error
```

`struct stat *`ì— íŒŒì¼ ë©”íƒ€ë°ì´í„°ê°€ ë‹´ê¸´ë‹¤. 

- [[Access permission bits defined in sys stat.h]]
- file types
	- `S_ISREG(m)`: Is this a regular file?
	- `S_ISDIR(m)`: Is this a directory?
	- `S_ISSOCK(m)`: Is this a network socket?

```c
/* Metadata returned by the stat and fstat functions */ 
struct stat { 
	dev_t st_dev; /* Device */ 
	ino_t st_ino; /* inode */ 
	mode_t st_mode; /* Protection and file type */ 
	nlink_t st_nlink; /* Number of hard links */ 
	uid_t st_uid; /* User ID of owner */ 
	gid_t st_gid; /* Group ID of owner */ 
	dev_t st_rdev; /* Device type (if inode device) */ 
	off_t st_size; /* Total size, in bytes */ 
	unsigned long st_blksize; /* Block size for filesystem I/O */ 
	unsigned long st_blocks; /* Number of blocks allocated */ 
	time_t st_atime; /* Time of last access */ 
	time_t st_mtime; /* Time of last modification */ 
	time_t st_ctime; /* Time of last change */
};
```

> [!question] ê·¸ëŸ°ë°, íŒŒì¼ ë©”íƒ€ë°ì´í„°ëŠ” ì‚¬ìš©ìê°€ ì„ì˜ëŒ€ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆëŠ”ê±° ì•„ë‹ˆì—ˆìŒ?

## 10.7. Read Directory Contents

```c
#include <sys/types.h> 
#include <dirent.h> 
DIR *opendir(const char *name);
// Returns: pointer to handle if OK, NULL on error
```

directory streamì˜ ì²«ë²ˆì§¸ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¨ë‹¤. í•´ë‹¹ ë””ë ‰í† ë¦¬ ì›ì†Œê°€ ê³ ê°ˆë  ë•Œê¹Œì§€ `readdir`ì„ í˜¸ì¶œí•˜ë©´ ë‹¤ìŒ `struct dirent *` í¬ì¸í„°ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤. 

```c
#include <dirent.h> 
struct dirent *readdir(DIR *dirp); 
// Returns: pointer to next directory entry if OK, NULL if no more entries or error
```

- `struct dirent`
	- `ino_t d_ino`: inode number
	- `char d_nme[256]`: filename

`DIR *` ê°ì²´ë¥¼ ë‹«ì„ ê²½ìš° `closedir`ì„ í˜¸ì¶œí•˜ë©´ ëœë‹¤.

## 10.8. Sharing Files

- Descriptor table: file descriptor ëª©ë¡, í”„ë¡œì„¸ìŠ¤ ë…ë¦½ì ì„.
- File table: ëª¨ë“  í”„ë¡œì„¸ìŠ¤ê°€ ê³µìœ í•˜ëŠ” ì—´ë¦° íŒŒì¼ ëª©ë¡. reference countingì„ í•œë‹¤. 0ì´ ë  ë•Œê¹Œì§€ file descriptorë¥¼ ë‹«ìœ¼ë©´ ë¹„ë¡œì†Œ ì‚­ì œëœë‹¤.
- v-node table: ëª¨ë“  í”„ë¡œì„¸ìŠ¤ê°€ ê³µìœ í•˜ëŠ” ì—´ë¦° íŒŒì¼ ëª©ë¡. File Tableê³¼ ë‹¤ë¥¸ ì ì€ ì–˜ëŠ” íŒŒì¼ ë©”íƒ€ë°ì´í„°ì¸ `struct stat`ì„ ê°€ì§€ê³  ìˆë‹¤.

> [!question]- í•œ í”„ë¡œì„¸ìŠ¤ê°€ ì—´ ìˆ˜ ìˆëŠ” íŒŒì¼ì˜ ê°œìˆ˜ëŠ” file descriptorì˜ ìµœëŒ€ì¹˜ê² ë„¤?  
> [stack exchange ë‹µë³€](https://unix.stackexchange.com/a/84244)ì— ë”°ë¥´ë©´, ì»¤ë„ì´ ì—´ ìˆ˜ ìˆëŠ” ìµœëŒ€ íŒŒì¼ì˜ ê°œìˆ˜ë¥¼ `/proc/sys/fs/file-max`ì— ì €ì¥í•´ ë†“ê³  ìˆë‹¤ê³  í•œë‹¤. ë‚´ ì»´í“¨í„°ëŠ” 2459860ê°œê°€ ë˜ëŠ”ë°, ì •ì‘ í”„ë¡œì„¸ìŠ¤ ë‹¹ file descriptorì˜ ê°œìˆ˜ëŠ” ë”±íˆ ì •í•´ì ¸ ìˆì§€ ì•Šì€ê²Œ, file descriptorëŠ” ê°™ì€ íŒŒì¼(v-node)ì„ ê°€ë¦¬í‚¬ ìˆ˜ë„ ìˆê³ , ê°™ì€ íŒŒì¼ í…Œì´ë¸”(file table)ì„ ê°€ë¦¬í‚¬ ìˆ˜ë„ ìˆìœ¼ë©°, ì•„ì˜ˆ ê°€ë¦¬í‚¤ì§€ ì•Šì„ ìˆ˜ë„ ìˆì–´ì„œë€ë‹¤.

## I/O Redirection

ì•„ì£¼ ì¤‘ìš”í•œ ê°œë…ì¸ **dup2**ì— ëŒ€í•´ì„œ ë‚˜ì˜¨ë‹¤. ë¦¬ëˆ…ìŠ¤ ì…¸ì—ì„œëŠ” `>`, `2>`, `<`ê°€ ìˆë‹¤. ê°ê° 

1. `lhs > rhs`: `lhs`ì˜ stdout ì¶œë ¥ ê²°ê³¼ë¥¼ `rhs`íŒŒì¼ë¡œ ë¦¬ë””ë ‰ì…˜ í•˜ì‹œì˜¤.
2. `lhs 2> rhs`: `lhs`ì˜ stderr ì¶œë ¥ ê²°ê³¼ë¥¼ `rhs` íŒŒì¼ë¡œ ë¦¬ë””ë ‰ì…˜ í•˜ì‹œì˜¤.
3. `lhs < rhs`: `rhs`íŒŒì¼ì„ `lhs`ì˜ stdinìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ í•˜ì‹œì˜¤.

```c
#include <unistd.h> 
int dup2(int oldfd, int newfd); 
// Returns: nonnegative descriptor if OK, âˆ’1 on error
```

descriptor tableì˜ `newfd`ë²ˆì§¸ ì¸ë±ìŠ¤ì˜ ê°’ì„ `oldfd`ì˜ ê°’ìœ¼ë¡œ ë®ì–´ì“´ë‹¤. ë§Œì•½ `newfd`ê°€ ì—´ë ¤ìˆë‹¤ë©´ ìë™ìœ¼ë¡œ ë‹«ëŠ”ë‹¤.
