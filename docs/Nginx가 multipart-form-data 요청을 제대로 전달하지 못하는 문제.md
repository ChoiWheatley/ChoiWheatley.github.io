---
aliases: 
tags: 
description:
title: Nginx가 multipart-form-data 요청을 제대로 전달하지 못하는 문제
created: 2024-09-02T18:07:54
updated: 2024-09-02T18:24:48
---

## 문제상황

Nginx에 물려있는 Django 서버에서 `/api/v1/image` 엔드포인트에 POST 요청을 사용하여 이미지 파일을 업로드 하려고 했습니다. 제목에서와 같이 바디 타입은 `multipart/form-data` 입니다.

이미지 파일을 업로드했을때 응답코드로 500 Internal Server Error가 발생하고 응답 HTML은 nginx 500이 나타났습니다. 

## 시도 및 해결

[다음 블로그](https://syaku.tistory.com/293) 글을 참조하여 `location /` 안에 다음 네 설정을 추가했더니 문제가 해결이 되었습니다. 

```nginx
location / {
	...
     client_body_temp_path           /tmp/;
     client_body_in_file_only        on;
     client_body_buffer_size         128K;
     client_max_body_size            100M;
}
```

## GPT 응답

Nginx에서 이미지 파일을 업로드하려고 했을 때 500 Internal Server Error가 발생한 것은 클라이언트가 업로드하는 데이터(예: 이미지 파일)를 처리하는 과정에서 문제가 발생했기 때문입니다. 이 문제의 원인은 Nginx의 기본 설정에서 클라이언트 요청의 본문을 처리할 수 있는 메모리 크기나 파일의 크기 제한이 너무 작거나 적절하게 설정되지 않았기 때문일 수 있습니다.

추가한 네 가지 설정에 대해 설명드리겠습니다:

1. **`client_body_temp_path /tmp/;`**: 클라이언트가 업로드하는 파일이 서버에 완전히 도착하기 전에 임시로 저장될 경로를 지정합니다. 이 설정이 없으면 Nginx가 업로드된 데이터를 처리할 때 적절한 임시 저장 공간을 찾지 못해 오류가 발생할 수 있습니다.

2. **`client_body_in_file_only on;`**: 클라이언트가 보낸 요청의 본문을 임시 파일에만 저장하도록 설정합니다. 이 설정은 큰 파일을 업로드할 때 메모리 사용을 줄여주기 때문에 메모리 부족으로 인한 오류를 방지할 수 있습니다.

3. **`client_body_buffer_size 128K;`**: 클라이언트 요청 본문을 버퍼에 저장할 때 사용할 메모리 크기를 설정합니다. 기본값이 작을 경우 큰 파일을 업로드할 때 메모리 부족 문제가 발생할 수 있습니다. 이 설정을 통해 충분한 버퍼 크기를 지정함으로써 문제를 해결할 수 있습니다.

4. **`client_max_body_size 100M;`**: 클라이언트가 업로드할 수 있는 요청 본문의 최대 크기를 설정합니다. 기본적으로 이 값이 작게 설정되어 있다면, 큰 파일을 업로드할 때 이 제한을 초과하여 413 Request Entity Too Large 오류가 발생할 수 있습니다. 이 값을 적절히 늘려줌으로써 큰 파일을 업로드할 수 있도록 합니다.

### 문제의 원인

문제의 원인은 클라이언트가 업로드하는 데이터(이미지 파일)를 처리하는 Nginx의 기본 설정이 적절하지 않아서 발생한 것입니다. 예를 들어, 업로드된 파일이 너무 커서 Nginx의 기본 `client_max_body_size` 제한을 초과했거나, Nginx가 클라이언트의 데이터를 처리할 때 사용할 임시 경로가 제대로 설정되지 않았거나, 메모리 버퍼 크기가 너무 작아서 업로드된 데이터를 처리하지 못한 경우가 있습니다.

### 유효한 해결 방법

당신이 추가한 설정들은 모두 문제를 해결하기 위해 적절한 방식으로 Nginx의 설정을 조정한 것입니다. 특히, `client_max_body_size`를 늘리고, `client_body_temp_path`를 적절하게 설정한 것이 중요한 역할을 합니다. 이러한 설정들은 Nginx가 큰 파일을 처리할 수 있도록 하고, 업로드된 데이터를 임시 파일로 안전하게 저장할 수 있도록 해줍니다.

결론적으로, Nginx의 기본 설정이 클라이언트가 업로드하는 데이터를 처리하기에 충분하지 않았고, 이로 인해 500 에러가 발생한 것입니다. 추가한 설정을 통해 Nginx의 처리 용량과 파일 저장 경로를 조정하여 문제를 해결한 것입니다.
